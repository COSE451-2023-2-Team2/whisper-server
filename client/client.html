<!doctype html>
<html>
	<head>
		<title>WebSocket Client Test</title>
		
		<script type="text/javascript" src="jquery-3.1.1.min.js"></script>
		<script type="text/javascript" src="simplewebsocket.min.js"></script>
		<script type="text/javascript">

			function SocketWrapper(init)
			{
				this.socket = new SimpleWebsocket(init);
				this.messageHandlers = {};
				
				var that = this;
				this.socket.on('data', function(data)
				{
					//Extract the message type
					var messageData = JSON.parse(data);
					//alert(messageData);
					console.log(JSON.stringify(messageData));
					var messageType = messageData['MessageType'];
					delete messageData['MessageType'];
					
					//If any handlers have been registered for the message type, invoke them
					if (that.messageHandlers[messageType] !== undefined)
					{
						for (index in that.messageHandlers[messageType]) {
							that.messageHandlers[messageType][index](messageData);
						}
					}
				});
			}
			
			SocketWrapper.prototype.on = function(event, handler)
			{
				//If a standard event was specified, forward the registration to the socket's event emitter
				if (['connect', 'close', 'data', 'error'].indexOf(event) != -1) {
					this.socket.on(event, handler);
				}
				else
				{
					//The event names a message type
					if (this.messageHandlers[event] === undefined) {
						this.messageHandlers[event] = [];
					}
					this.messageHandlers[event].push(handler);
				}
			}
			
			SocketWrapper.prototype.send = function(message, payload)
			{
				//Copy the values from the payload object, if one was supplied
				var payloadCopy = {};
				if (payload !== undefined && payload !== null)
				{
					var keys = Object.keys(payload);
					for (index in keys)
					{
						var key = keys[index];
						payloadCopy[key] = payload[key];
					}
				}
				
				payloadCopy['MessageType'] = message;
				this.socket.send(JSON.stringify(payloadCopy));
			}
			
			function log(text)
			{
				var outputElem = $('#output');
				outputElem.text( outputElem.text() + text + '\n' );
			}
			
			$(document).ready(function()
			{
				var socket = new SocketWrapper("ws://192.168.35.175:8080");
				log("Left box is for MessageType and right box is for inputs. \n" +
						"In order to register an account, input on left box register and on right box enter your email,id,pw with the comma as separator \n" +
						"In order to login, input on left box login and on right box enter your id,pw with the comma as separator \n" +
						"In order to message, input on left box message and on right box enter your message. *needs to be logged in*");
				//Generic events
				localStorage.clear();
				
				socket.on('connect', function() {
					log("socket is connected!");
				});
				
				socket.on('data', function(data) {
					log('got message: ' + data)
					const obj = JSON.parse(data);
					if(obj["Success"] === "Successful login"){
						localStorage.setItem("userid",obj["id"]);
						console.log(localStorage.getItem("userid"));
					}
				});
				
				socket.on('close', function() {
					log("socket is disconnected!");
					localStorage.removeItem("userid");
				});
				
				socket.on('error', function(err) {
					log("Error: " + err);
				});
				
				//Specific message type handlers
				
				socket.on('userInput', function(args) {
					log("Received user input: \"" + args['input'] + "\"");
				});
				
				$('#send').click(function() {
					var temp;
					if(localStorage.getItem("userid") === null && $('#message').val() === "login"){
						const array = $('#args').val().split(",");
						temp = '{"id":"' + array[0] + '", "pw":"' + array[1] + '"}';
						socket.send($('#message').val(), JSON.parse(temp));
					} else if(localStorage.getItem("userid") === null && $('#message').val() === "register"){
						const array = $('#args').val().split(",");
						temp = '{"email":"' + array[0] + '", "id":"' + array[1] + '", "pw":"' + array[2] + '"}';
						socket.send($('#message').val(), JSON.parse(temp));
					} else if(localStorage.getItem("userid") != null && $('#message').val() === "message"){
						temp = '{"id":"' + localStorage.getItem("userid") +'", "input":"' + $('#args').val() + '"}';
						socket.send($('#message').val(), JSON.parse(temp));
					} else if($('#message').val() === "register" && localStorage.getItem("userid") != null){
						log("You need to logout first in order to register (refresh the page)");
					} else if($('#message').val() === "message" && localStorage.getItem("userid") === null){
						log("You need to login first before you can message");
					} else if(localStorage.getItem("userid") != null && $('#message').val() === "login"){
						log("You are already logged in");
					}else {
						log("invalid inputs. Check if the correct action is written in the left box and the correct input for the right box");
					}
					//var temp = '{' + localStorage.getItem("userid") + $('#args').val() + '}';
					//var temp = '{' + localStorage.getItem("userid") + ':' + $('#args').val() + '}';
					//socket.send($('#message').val(), JSON.parse(temp));
				});
			});
			
		</script>
	</head>
	
	<body>
		<input type="text" id="message" value="message">
		<input type="text" id="args" value='{"a":1, "b":2, "c":3}'>
		<button id="send">Send Message</button>
		<pre id="output"></pre>
	</body>
</html>